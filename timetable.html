<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>交互式课程时间表</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #1a202c; /* 深色背景 */
            color: #e2e8f0; /* 浅色文本 */
        }
        .task-item.completed .task-text {
            text-decoration: line-through;
            color: #6b7280;
        }
        .task-notes {
            min-height: 20px;
            padding: 8px;
            border-radius: 6px;
            transition: background-color 0.2s;
        }
        .task-notes:hover {
            background-color: #2d3748;
        }
        .today-highlight {
            border: 2px solid #4985a7; /* 今天的日期高亮边框 */
            background-color: #1f2937; /* 今天的日期背景色 */
        }
        .current-task-highlight {
            border-left: 4px solid #ee0a0a; /* 当前任务高亮边框 */
            box-shadow: 0 0 10px rgba(245, 70, 1, 0.5); /* 光晕效果 */
        }
        /* Custom scrollbar for better appearance */
        .overflow-y-auto::-webkit-scrollbar {
            width: 8px;
        }
        .overflow-y-auto::-webkit-scrollbar-track {
            background: #2d3748;
        }
        .overflow-y-auto::-webkit-scrollbar-thumb {
            background-color: #4a5568;
            border-radius: 4px;
            border: 2px solid #2d3748;
        }
    </style>
</head>
<body class="p-4 sm:p-8">

    <div class="max-w-4xl mx-auto bg-gray-800 rounded-xl shadow-2xl p-6 sm:p-8">
        <div class="flex justify-between items-center mb-6">
            <h1 class="text-2xl sm:text-3xl font-bold text-indigo-400">
                2025-2026秋季学期 第X周日程待办清单
            </h1>
            <button id="clearAllBtn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-full transition-colors duration-200 text-sm">
                清除所有进度
            </button>
        </div>

        <!-- 当前时间显示窗口 -->
        <div id="current-time-display" class="text-center text-3xl sm:text-4xl font-mono font-bold text-green-400 mb-6 py-4 px-6 bg-gray-900 rounded-lg shadow-inner border border-gray-700">
            <!-- JavaScript will update this -->
        </div>

        <p class="text-gray-400 mb-8 text-sm sm:text-base">
            Developed by garyagasa547@gmail.com
        </p>

        <div id="schedule-container" class="space-y-4">
            <!-- 内容将由 JavaScript 生成 -->
        </div>
    </div>

    <script>
        // 课程节次与时间的映射，参考复旦大学时间表
        // 14、15节为顺延时间，此处为合理假设，如有不同可自行修改
        const periodTimes = {
            1: { start: '08:00', end: '08:45' },
            2: { start: '08:55', end: '09:40' },
            3: { start: '09:55', end: '10:40' },
            4: { start: '10:50', end: '11:35' },
            5: { start: '11:45', end: '12:30' },
            6: { start: '13:30', end: '14:15' },
            7: { start: '14:25', end: '15:10' },
            8: { start: '15:25', end: '16:10' },
            9: { start: '16:20', end: '17:05' },
            10: { start: '17:15', end: '18:00' },
            11: { start: '18:30', end: '19:15' },
            12: { start: '19:25', end: '20:10' },
            13: { start: '20:20', end: '21:05' },
            14: { start: '21:15', end: '22:00' }, // 顺延假设
            15: { start: '22:30', end: '23:40' }  // 顺延假设
        };

        // 定义课程数据，根据你提供的文件内容进行格式化
        const scheduleData = {
            "星期一": [
                { name: "数字逻辑与部件设计", time: "1-5节" },
                { name: "数据结构", time: "6-8节" },
                { name: "数据结构复习、作业I", time: "9-10节" },
                { name: "陶渊明(数逻复习)", time: "11-12节" },
                { name: "数逻作业", time: "13节" },
                { name: "CSAPP Reading I", time: "14-15节" },
                { name: "机动", time: "无" }
            ],
            "星期二": [
                { name: "数据结构", time: "1-2节" },
                { name: "数据结构复习II", time: "3节" },
                { name: "集合与图论", time: "4-5节" },
                { name: "形策(数逻预习)", time: "6-7节" },
                { name: "集合与图论复习、作业I", time: "8-9节" },
                { name: "数据结构作业II", time: "10节" },
                { name: "CSAPP Lecture I", time: "11-12节" },
                { name: "CSAPP Review I", time: "13节" },
                { name: "CSAPP Project", time: "14-15节" },
                { name: "机动", time: "无" }
            ],
            "星期三": [
                { name: "NLP Reading I", time: "1-2节" },
                { name: "计算机视觉", time: "3-5节" },
                { name: "概率论与数理统计", time: "6-8节" },
                { name: "概统复习、作业I", time: "9-10节" },
                { name: "CV复习、作业I", time: "11-12节" },
                { name: "NLP Lecture I", time: "13-14节" },
                { name: "NLP Review I", time: "15节" },
                { name: "机动", time: "无" }
            ],
            "星期四": [
                { name: "CS189 Reading I", time: "1-2节" },
                { name: "排球(一)", time: "3-4节" },
                { name: "NLP PaperReading I", time: "5节" },
                { name: "集合与图论", time: "6-7节" },
                { name: "集合与图论复习、作业II", time: "8-9节" },
                { name: "NLP Assignment I", time: "10节" },
                { name: "CS189 Lecture I", time: "11-12节" },
                { name: "CS189 Review I", time: "13节" },
                { name: "CS189 Discussion I", time: "14节" },
                { name: "CS189 Project", time: "15节" },
                { name: "机动", time: "无" }
            ],
            "星期五": [
                { name: "CSAPP Reading II", time: "1-2节" },
                { name: "思想道德与法治(CV复习、作业)", time: "3-5节" },
                { name: "概率论与数理统计", time: "6-7节" },
                { name: "概统复习、作业II", time: "8-9节" },
                { name: "CSAPP Lecture I", time: "10-11节" },
                { name: "CSAPP Review I", time: "12节" },
                { name: "CSAPP Project", time: "13节" },
                { name: "机动", time: "14节" },
                { name: "CSAPP Project", time: "15节" },
                { name: "机动", time: "无" }
            ],
            "星期六": [
                { name: "NLP Reading II", time: "1-2节" },
                { name: "数据结构周复习、ReadingI", time: "3-4节" },
                { name: "概统周复习、预习I(含中午)", time: "5节" },
                { name: "集合与图论周复习、预习I、习题I", time: "6-8节"},
                { name: "CV周复习、Reading I", time: "9-10节" },
                { name: "NLP Lecture II", time: "11-12节" },
                { name: "NLP Review II", time: "13节" },
                { name: "NLP PaperReading II", time: "14节" },
                { name: "NLP Assignment II", time: "15节"},
                { name: "机动", time: "无" }
            ],
            "星期日": [
                { name: "CS189 Reading II", time: "1-2节" },
                { name: "集合与图论预习II、习题II", time: "3-4节" },
                { name: "数据结构Reading II、作业III", time: "5节" },
                { name: "概统预习II、习题I, 习题II", time: "6-8节" },
                { name: "CV Reading II、作业", time: "10节" },
                { name: "CS189 Lecture II", time: "11-12节" },
                { name: "CS189 Review II", time: "13节" },
                { name: "CS189 Discussion II", time: "14节" },
                { name: "CS189 Project", time: "15节" },
                { name: "机动", time: "无" }
            ]
        };

        const scheduleContainer = document.getElementById('schedule-container');
        const clearAllBtn = document.getElementById('clearAllBtn');
        const currentTimeDisplay = document.getElementById('current-time-display');
        const storageKey = 'weeklyScheduleState';
        const dayNames = ["星期日", "星期一", "星期二", "星期三", "星期四", "星期五", "星期六"];

        // 函数：更新时钟显示
        const updateClock = () => {
            const now = new Date();
            const year = now.getFullYear();
            const month = (now.getMonth() + 1).toString().padStart(2, '0');
            const day = now.getDate().toString().padStart(2, '0');
            const hour = now.getHours().toString().padStart(2, '0');
            const minute = now.getMinutes().toString().padStart(2, '0');
            const second = now.getSeconds().toString().padStart(2, '0');
            currentTimeDisplay.innerText = `${year}-${month}-${day} ${hour}:${minute}:${second}`;
        };

        // 函数：解析时间字符串并返回开始和结束时间
        const parseTaskTime = (timeString) => {
            const now = new Date();
            let startPeriod, endPeriod;
            
            // 匹配 "1-5节" 或 "6节" 模式
            const match = timeString.match(/(\d+)(?:-(\d+))?节/);
            if (!match) return null;

            startPeriod = parseInt(match[1], 10);
            endPeriod = match[2] ? parseInt(match[2], 10) : startPeriod;

            if (!periodTimes[startPeriod] || !periodTimes[endPeriod]) {
                return null;
            }

            // 根据节次获取时间
            const startHour = parseInt(periodTimes[startPeriod].start.split(':')[0], 10);
            const startMinute = parseInt(periodTimes[startPeriod].start.split(':')[1], 10);
            const endHour = parseInt(periodTimes[endPeriod].end.split(':')[0], 10);
            const endMinute = parseInt(periodTimes[endPeriod].end.split(':')[1], 10);

            // 创建今天的开始和结束时间对象
            const startTime = new Date(now.getFullYear(), now.getMonth(), now.getDate(), startHour, startMinute, 0);
            const endTime = new Date(now.getFullYear(), now.getMonth(), now.getDate(), endHour, endMinute, 59);
            
            return { startTime, endTime };
        };

        // 函数：高亮显示当前正在进行的任务
        const updateCurrentTaskHighlight = () => {
            const now = new Date();
            const todayName = dayNames[now.getDay()];
            
            // 首先移除所有已有的高亮
            document.querySelectorAll('.current-task-highlight').forEach(el => {
                el.classList.remove('current-task-highlight');
            });

            // 检查今天是否有任务
            const todaySection = document.querySelector(`.day-section[data-day="${todayName}"]`);
            if (!todaySection) return;

            const tasks = scheduleData[todayName];
            tasks.forEach((task, index) => {
                const timeInfo = parseTaskTime(task.time);
                if (timeInfo) {
                    const { startTime, endTime } = timeInfo;
                    // 判断当前时间是否在任务时间段内
                    if (now >= startTime && now <= endTime) {
                        const taskItem = todaySection.querySelectorAll('.task-item')[index];
                        if (taskItem) {
                            taskItem.classList.add('current-task-highlight');
                        }
                    }
                }
            });
        };

        // 函数：保存状态到 localStorage
        const saveState = () => {
            const state = {};
            document.querySelectorAll('.day-section').forEach(daySection => {
                const day = daySection.getAttribute('data-day');
                const dayState = {
                    expanded: !daySection.querySelector('.day-header').classList.contains('collapsed'),
                    tasks: []
                };
                daySection.querySelectorAll('.task-item').forEach(taskItem => {
                    const taskText = taskItem.querySelector('.task-text').innerText;
                    const notes = taskItem.querySelector('.task-notes').innerText;
                    const isCompleted = taskItem.classList.contains('completed');
                    dayState.tasks.push({ taskText, notes, isCompleted });
                });
                state[day] = dayState;
            });
            localStorage.setItem(storageKey, JSON.stringify(state));
        };

        // 函数：从 localStorage 加载状态
        const loadState = () => {
            const storedState = localStorage.getItem(storageKey);
            return storedState ? JSON.parse(storedState) : null;
        };

        // 函数：渲染日程表
        const renderSchedule = () => {
            const savedState = loadState();
            const today = new Date().getDay(); // 获取当前星期几 (0=星期日, 1=星期一, ...)
            const todayName = dayNames[today];

            // 清除旧内容
            scheduleContainer.innerHTML = '';

            // 为每一天生成 HTML
            for (const day in scheduleData) {
                const tasks = scheduleData[day];
                const dayState = savedState && savedState[day] ? savedState[day] : null;
                const isExpanded = dayState ? dayState.expanded : true;
                const isCollapsedClass = isExpanded ? '' : 'hidden';

                const daySection = document.createElement('div');
                daySection.setAttribute('data-day', day);
                daySection.className = `day-section bg-gray-700 rounded-xl shadow-lg ${day === todayName ? 'today-highlight' : ''}`;

                const dayHeader = document.createElement('div');
                dayHeader.className = 'day-header flex justify-between items-center p-4 cursor-pointer hover:bg-gray-600 transition-colors rounded-t-xl';
                dayHeader.innerHTML = `
                    <h2 class="text-xl font-semibold text-indigo-300">${day} ${day === todayName ? '<span class="text-xs ml-2 text-indigo-200">(今天)</span>' : ''}</h2>
                    <span class="text-gray-400 transform transition-transform ${isExpanded ? '' : 'rotate-180'}">▼</span>
                `;
                daySection.appendChild(dayHeader);

                const taskList = document.createElement('ul');
                taskList.className = `p-4 space-y-4 ${isCollapsedClass}`;

                tasks.forEach((task, index) => {
                    const taskState = dayState && dayState.tasks[index] ? dayState.tasks[index] : {};
                    const isCompleted = taskState.isCompleted || false;
                    const notes = taskState.notes || '';
                    
                    const taskItem = document.createElement('li');
                    taskItem.className = `task-item flex flex-col sm:flex-row items-start sm:items-center space-y-2 sm:space-y-0 sm:space-x-4 p-4 rounded-lg transition-colors ${isCompleted ? 'completed bg-gray-800' : 'bg-gray-800 hover:bg-gray-600'}`;
                    
                    taskItem.innerHTML = `
                        <div class="flex items-center flex-grow w-full">
                            <input type="checkbox" class="h-5 w-5 text-indigo-600 rounded focus:ring-indigo-500 bg-gray-600 border-gray-500" ${isCompleted ? 'checked' : ''}>
                            <span class="task-text ml-3 text-base sm:text-lg font-medium flex-grow">${task.name} <span class="text-xs text-gray-500 ml-2">${task.time}</span></span>
                        </div>
                        <div class="flex-grow w-full mt-2 sm:mt-0">
                            <div class="task-notes w-full text-sm text-gray-400 bg-gray-900 border border-gray-600 rounded-lg p-2 focus:outline-none focus:border-indigo-500 transition-colors overflow-y-auto" contenteditable="true" placeholder="点击此处添加备注...">${notes}</div>
                        </div>
                    `;
                    taskList.appendChild(taskItem);

                    // Add event listeners for notes
                    taskItem.querySelector('.task-notes').addEventListener('input', saveState);

                    // Add event listener for checkbox
                    taskItem.querySelector('input[type="checkbox"]').addEventListener('change', (e) => {
                        if (e.target.checked) {
                            taskItem.classList.add('completed');
                        } else {
                            taskItem.classList.remove('completed');
                        }
                        saveState();
                    });
                });
                daySection.appendChild(taskList);

                // Add event listener for header to toggle visibility
                dayHeader.addEventListener('click', () => {
                    const isCurrentlyExpanded = !dayHeader.classList.contains('collapsed');
                    const icon = dayHeader.querySelector('span');
                    if (isCurrentlyExpanded) {
                        taskList.classList.add('hidden');
                        dayHeader.classList.add('collapsed');
                        icon.classList.add('rotate-180');
                    } else {
                        taskList.classList.remove('hidden');
                        dayHeader.classList.remove('collapsed');
                        icon.classList.remove('rotate-180');
                    }
                    saveState();
                });
                
                // If a day was collapsed, hide the task list
                if (!isExpanded) {
                    taskList.classList.add('hidden');
                    dayHeader.classList.add('collapsed');
                    dayHeader.querySelector('span').classList.add('rotate-180');
                }

                scheduleContainer.appendChild(daySection);
            }
            updateCurrentTaskHighlight();
        };

        // 事件监听：清除所有进度
        clearAllBtn.addEventListener('click', () => {
            // 使用自定义模态框代替 confirm()
            const confirmBox = document.createElement('div');
            confirmBox.innerHTML = `
                <div class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4">
                    <div class="bg-gray-800 p-6 rounded-xl shadow-lg max-w-sm w-full text-center">
                        <h3 class="text-lg font-bold text-white mb-4">确定要清除所有进度吗？</h3>
                        <p class="text-sm text-gray-400 mb-6">此操作无法撤销。</p>
                        <div class="flex justify-around">
                            <button id="confirm-yes" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-full transition-colors duration-200 text-sm">确定</button>
                            <button id="confirm-no" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-full transition-colors duration-200 text-sm">取消</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(confirmBox);

            document.getElementById('confirm-yes').addEventListener('click', () => {
                localStorage.removeItem(storageKey);
                renderSchedule();
                confirmBox.remove();
            });

            document.getElementById('confirm-no').addEventListener('click', () => {
                confirmBox.remove();
            });
        });

        // 页面加载时渲染，并每分钟更新一次时间高亮
        window.onload = function() {
            renderSchedule();
            setInterval(updateCurrentTaskHighlight, 60000); // 每分钟更新一次
            updateClock();
            setInterval(updateClock, 1000); // 每秒更新时钟
        };
    </script>
</body>
</html>